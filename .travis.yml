services:
  - docker

language: bash

env:
  global:
    - NAME=super_unko
    - CACHE_DIR=$HOME/docker-image
    - BASE_IMAGE=unkontributors/$NAME
    - BASE_IMAGE_CACHE_FILE=$CACHE_DIR/$NAME-base.tgz
    - SHFMT_CACHE_FILE=$CACHE_DIR/shfmt.tgz
    - SHELLCHECK_CACHE_FILE=$CACHE_DIR/shellcheck.tgz

matrix:
  include:
    - os: linux
      env: SH_VERSION=default
    - os: linux
      env: SH_VERSION=3.2
    - os: linux
      env: SH_VERSION=4.0
    - os: linux
      env: SH_VERSION=4.1
    - os: linux
      env: SH_VERSION=4.2
    - os: linux
      env: SH_VERSION=4.3
    - os: linux
      env: SH_VERSION=4.4
    - os: linux
      env: SH_VERSION=5.0

cache:
  bundler: true
  directories:
    - ${CACHE_DIR}

install:
    ## Load cache of docker images
  - |
    if [[ -f "$SHFMT_CACHE_FILE" ]]; then
      docker load -i "$SHFMT_CACHE_FILE"
    fi
  - |
    if [[ -f "$SHELLCHECK_CACHE_FILE" ]]; then
      docker load -i "$SHELLCHECK_CACHE_FILE"
    fi
  - |
    if [[ -f "$BASE_IMAGE_CACHE_FILE" ]]; then
      docker load -i "$BASE_IMAGE_CACHE_FILE"
    fi
  - |
    if [[ -f "$CACHE_DIR/${NAME}-${TRAVIS_OS_NAME}-${SH_VERSION}.tgz" ]]; then
      docker load -i "$CACHE_DIR/${NAME}-${TRAVIS_OS_NAME}-${SH_VERSION}.tgz"
    fi
    ## Setup docker image for lint
  - ./linter.sh setup
  - docker save "peterdavehello/shfmt" | gzip -c > $SHFMT_CACHE_FILE
  - docker save "koalaman/shellcheck" | gzip -c > $SHELLCHECK_CACHE_FILE
  - mkdir -p $CACHE_DIR
    ## Build base image
  - docker-compose build
  - docker save $BASE_IMAGE | gzip -c > $BASE_IMAGE_CACHE_FILE
    ## Build CI image
  - docker-compose -f docker-compose-ci.yml build ci_sh_${SH_VERSION}
  - docker save ${NAME}_ci_sh_${SH_VERSION} | gzip -c > $CACHE_DIR/${NAME}-${TRAVIS_OS_NAME}-${SH_VERSION}.tgz

script:
  - ls -la $CACHE_DIR
  - make lint
  - docker-compose -f docker-compose-ci.yml run ci_sh_${SH_VERSION}
